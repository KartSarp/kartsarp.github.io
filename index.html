<!DOCTYPE html>
<html>
<head>
  <title>DDD Fedback</title>

  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  
  <link rel="stylesheet" href="https://js.arcgis.com/4.9/esri/css/main.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web">
  <script src="https://js.arcgis.com/4.9/"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
		html,
		body {
		  height: 100%;
		  width: 100%;
		  margin: 0;
		  font-family: sans-serif;
		  font-family: "Titillium Web", normal;
		}
		#u_0_0 {
		  width:auto;
		}

		#viewDiv {
		  float: left;
		  padding: 0;
		  margin: 0;
		  height: -webkit-calc(100% - 70px);
		  height: -moz-calc(100% - 70px);
		  height: calc(100% - 70px);
		  width: 100%;
		}
		#comment{
		  float: left;
		  height: 100%;
		  width: 30%;
		}
		#knapp_esc, #knapp_opn {
		  pointer-events: auto;
		  font-size: x-large;
		  text-align: center;
		  border: 1px solid #dfdfdf;
		  background: white;
		  height: 30px;
		  width: 30px;
		  position: absolute;
		  z-index: 80;
		  box-shadow: 1px 1px 1px grey;
		  line-height: normal;
		}
		#knapp_esc{
		  bottom: -40px;
		}
		#knapp_opn {
		  right: 0px;
		  background-image: 'layers.png';
		}
		#knapp_esc:hover {
		  cursor: pointer;
		}
		#knapp_opn:hover {
		  cursor: pointer;
		}

		.cont {
		  height: 100%;
		  width: 70%;
		  float: left;
		}
		#tittel {
		  height: 70px;
		  background-color: #007aad;
		}
		.flex-container {
		  display: flex;
		  align-items: center;
		  justify-content: center;
		}

		#navn {
		  width: 70%;
		  height: 100%;
		  float: left;
		  font-size: xx-large;
		  font-family: sans-serif;
		  color: white;
		}
		.lenker {
		  width: 30%;
		  height: 100%;
		  float: left;
		  font-size: large;
		  font-family: sans-serif;
		  color: black;
		}
		#navn {

		  /* Internet Explorer 10 */
		  display:-ms-flexbox;
		  -ms-flex-pack:center;
		  -ms-flex-align:center;

		  /* Firefox */
		  display:-moz-box;
		  -moz-box-pack:center;
		  -moz-box-align:center;

		  /* Safari, Opera, and Chrome */
		  display:-webkit-box;
		  -webkit-box-pack:center;
		  -webkit-box-align:center;

		  /* W3C */
		  display:box;
		  box-pack:center;
		  box-align:center;
		}

		img {
		  vertical-align: unset;
		}

		.planknapp {
		  float: right;
		  margin-right: 20px;
		  margin-top: 14px;


		}

		#sendkommentar {
		  margin: 15px;
		  margin-left: auto;
		  margin-right: auto;
		  display: none; 





		}
		#skjema {
		  display: none;
		}
		textarea {
			resize: none;
		}
		form {
		  width: 90%;
		  margin: auto;
		}
		#komment {
		  width: 100%;
		  height: 50px;
		}
		#sendkommentar:hover {
		  cursor: pointer;
		}
		#kommentarfelt {
		  width: 100%;
		  height: auto;
		  max-height: calc(100% - 200px);
		  overflow: scroll;
		  /*display: flex;*/
		  flex-direction: column; 
		}
		




		.singlecomment {
		  word-break: break-word;
		  width: 90%;
		  min-height: 70px;
		  margin-left: auto;
		  margin-right: auto;
		  display: flex;
		  margin-bottom: 10px;
		  border-bottom: 1px solid lightgrey;
		  background-color: white;
		  background-image: linear-gradient(#e3e0e06b, #d3d3d345, #ededed59);


		}
		.bilde {

		  width: 50px;
		  float: left;
		  margin-top: auto;
		  margin-bottom: auto;
		  margin-right: 5px;

		}
		.tekst {
			 width: calc(100% - 95px);
			 float: left;
			 display: flex;
			 flex-direction: column;
			 justify-content: center;
		}
		.likediv {
			width: 40px;
			height: 40px;
			float: left;
			display: flex;
			flex-direction: column;

		}
		.likecount {
			text-align: center;
			font-family: sans-serif;
		}


		.navn {

		  width: 100%;

		}
		.komm {

		  width: 100%;

		}

		#fblogin {
			 display: block;
			 margin: auto;
			 width: 153px;
			 margin-left: auto;
			 margin-right: auto;
		}

		#status {
		  text-align: center;
		  margin-bottom: 10px;
		  color: #00b94d;
		  font-size: small;
		}

		#fblogin {
		  display: block;
		  margin: auto;
		}



		.velkommen {
			 position: fixed; /* Stay in place */
			 left: 0;
			 top: 0;
			 width: 100%; /* Full width */
			 height: 100%; /* Full height */
			 overflow: auto; /* Enable scroll if needed */
			 background-color: transparent;
			 z-index: 99;
		}

		/* Modal Content/Box */
		.velkommen-innh {
			 background-color: #fefefe;
			 margin: 5% auto; /* 5% from the top and centered */
			 padding: 20px;
			 border: 1px solid #888;
			 max-height: 90%;
			 max-width: 300px; /* Could be more or less, depending on screen size */
			 overflow: auto;
		}



		.gradient-border {
			margin-top: 3px;
		  --borderWidth: 3px;
		  position: relative;
		  border-radius: var(--borderWidth);
		}
		.gradient-border:after {
		  content: '';
		  position: absolute;
		  top: calc(-1 * var(--borderWidth));
		  left: calc(-1 * var(--borderWidth));
		  height: calc(100% + var(--borderWidth) * 2);
		  width: calc(100% + var(--borderWidth) * 2);
		  background: linear-gradient(60deg, #0066ff, #33cc33);
		  border-radius: calc(2 * var(--borderWidth));
		  z-index: -1;
		  animation: animatedgradient 3s ease alternate infinite;
		  background-size: 300% 300%;
		}

		.dato {
			font-size: 12px;
			color: gray;
		}


		@keyframes animatedgradient {
			0% {
				background-position: 0% 50%;
			}
			50% {
				background-position: 100% 50%;
			}
			100% {
				background-position: 0% 50%;
			}
		}





		/* On screens that are 992px or less, set the background color to blue */
		@media screen and (max-width: 992px) {
		  .cont {
			 height: 65%;
			 width: 100%;
			 float: left;
		  }   
		  #comment{
			 float: left;
			 height: 35%;
			 width: 100%;
		  }
		}

		/* On screens that are 600px or less, set the background color to olive */
		@media screen and (max-width: 600px) {
		  .cont {
			 height: 60%;
			 width: 100%;
			 float: left;
		  }

		  #comment{
			 height: 40%;
			 width: 100%;
		  }
		}




  </style>
  <script type="text/javascript">

		require([
		  "esri/WebScene",
		  "esri/views/SceneView",
		  "esri/layers/SceneLayer",
		  "esri/widgets/Legend",
		  "esri/widgets/LayerList"
		], function(WebScene, SceneView, SceneLayer, Legend, LayerList) {



		  var webscene = new WebScene({
			 portalItem: {
				id: "7cc83e9889a74c408d480331ae1c63dc"
			 }

		  });

		  var view = new SceneView({
			 container: "viewDiv",
			 map: webscene
		  });

		  view.when(function() {
			 var layerList = new LayerList({
						view: view
			 });
			 view.ui.add(layerList, "top-right");
			 let hoyde = $(".esri-ui-top-right").height();
			 console.log(hoyde);
			 $(".esri-ui-top-right").hide();
			 $(".esri-ui-top-right").append("<div id='knapp_esc'>&times;</div>");
			 $(".esri-ui-corner-container").append("<div id='knapp_opn'><img src='http://kart.sarpsborg.com/app/comment/img/layerlist.svg'/></div>")



			 $("#knapp_esc").on('click', function(){
				$(".esri-ui-top-right").hide(); 
				$("#knapp_opn").show();

				
			 });
			 $("#knapp_opn").on('click', function(){
				$(".esri-ui-top-right").show();
				$("#knapp_opn").hide();
			 });

		  });
		});

		
	 
  </script>
</head>
<body>

  <script>
  		//https://github.com/KartSarp/kartsarp.github.io/commit/5c43959f40b54dcf6d5e7bf3911d7749f2283b1f#diff-eacf331f0ffc35d4b482f1d15a887d3b    er FUNGERENDE

  		$(document).ready(function(){


		require([
				"dojo/on",
				"esri/layers/FeatureLayer",
				"esri/Graphic",
				"esri/tasks/QueryTask",
				"esri/tasks/support/Query",
				"esri/tasks/support/RelationshipQuery"
			],
			function(on, FeatureLayer, Graphic, QueryTask, Query, RelationshipQuery) {



				// This is called with the results from from FB.getLoginStatus().
				function statusChangeCallback(response) {
					console.log('statusChangeCallback');
					console.log(response);
					// The response object is returned with a status field that lets the
					// app know the current login status of the person.
					// Full docs on the response object can be found in the documentation
					// for FB.getLoginStatus().
					if (response.status === 'connected') {
						// Logged into your app and Facebook.
						$("#fblogin").hide();
						document.getElementById('status').innerHTML = 'Du er nå logget inn.';
						$("#skjema").show()
						innlogget();
					} else {
						// The person is not logged into your app or we are unable to tell.
						document.getElementById('status').innerHTML = 'Logg inn med Facebook for å kommentere.';
					}
				};

				//Sjekker hvilke posts som den innloggede brukeren har liket, og gir like-knappen en annen farge dersom brukeren har liket posten. 
				function sjekkLikes(brukerid) {
					for (var c in likes) {
						if (likes[c].attributes.userid == brukerid) {
							console.log("Brukeren har liket innlegget" + likes[c].attributes.kommentar_id);
							$("#" + likes[c].attributes.kommentar_id).find(".likebilde").css("background-color", "tomato");
						}
					};
				};

				// Setter opp en handler til å reagere når LIKES-objektet blir populated
				window.handler = {
					set: function(obj, prop, value) {
					  	if (prop == 'data') {
					    	console.log('Objektet ble fylt');
					    	sjekkLikes(brukerid);
					    } else {
					    	console.log("Error");
					    };
					    console.log("Gjort ingenting");
				  	}
				};

				p = {};
				//Definerer et tomt likes-object
				likes = {};



				//Kjøres etter en har forsøkt å logge inn med facebook dialogen.
				window.checkLoginState = function() {
					console.log("kjører checkLoginState");
					FB.getLoginStatus(function(response) {
						statusChangeCallback(response);
						console.log("kaller statusChangeCallback");
					});
				};


				(function(d, s, id) {
					var js, fjs = d.getElementsByTagName(s)[0];
					if (d.getElementById(id)) {
						return;
					}
					js = d.createElement(s);
					js.id = id;
					js.src = "https://connect.facebook.net/en_US/sdk.js";
					fjs.parentNode.insertBefore(js, fjs);
				}(document, 'script', 'facebook-jssdk'));

				window.fbAsyncInit = function() {
					FB.init({
						appId: '371994680203106',
						cookie: true,
						xfbml: true,
						version: 'v3.2'
					});

					FB.AppEvents.logPageView();

					FB.getLoginStatus(function(response) {
						statusChangeCallback(response);
					});

				};



				const featureLayer = new FeatureLayer({
					url: "https://services.arcgis.com/43oQDcO8lvhTZSOO/arcgis/rest/services/tabeller/FeatureServer/1",
					outFields: ["*"],
					popupEnabled: false,
					id: "feedbacklayer"
				});
				const likeTable = new FeatureLayer({
					url: "https://services.arcgis.com/43oQDcO8lvhTZSOO/arcgis/rest/services/tabeller/FeatureServer/0",
					outFields: ["*"],
					popupEnabled: false,
					id: "likeTable"
				});

				featureLayer.when(function () {
					console.log("FeatureLayer Relationships", featureLayer.relationships);
				});
				
				var query = featureLayer.createQuery();
				query.where = "1=1";
				query.outFields = ["*"];


				const relquery = likeTable.createQuery();
				query.where = "1=1";
				relquery.outFields = ["*"];




				console.log("Relationship query", relquery);


				function hentkommentarer() {

					featureLayer.queryFeatures(query)
						.then(function(response) {
							kommentarer = response.features;
							//SORTER INNLEGG ETTER DATO
							kommentarer_sorted=kommentarer.sort(function(a,b) {
							    return new Date(b.timedate) - new Date(a.timedate);
							});
							//Snur lista slik at når den itereres over vil de nye kommentarene komme øverst i kommentarfeltet
							kommentarer_sorted.reverse();
							console.log("Attributter", kommentarer_sorted);
							/*
							featureLayer.queryRelatedFeatures(relquery).then(function(result){
								console.log(result);
							}).catch(function(error) {
								console.error("Error from queryRelatedFeatures");
							});
							*/
							//Lager et objekt med data som inneholder alle likes, og hvilke posts de hører til. 
							//var likes;
							likeTable.queryFeatures(relquery)
								.then(function(response) {
									//likes.data=response.features;
									console.log("LikesResponse", response.features);
									
									likes = response.features;
									//Prøver å trigge Handleren her
									p.data = "likes";

									console.log("Likes", likes);
									num_com = kommentarer_sorted.length;
									for (var x in kommentarer_sorted) {
										//sjekk likestable for om kommentaren har likes, og hvor mange.
										//reutner true hvis brukeren  har liket og returner asnt likes. 
										//let bruker = kommentarer_sorted[x].attributes.userid;
										var comment_id = kommentarer_sorted[x].attributes.OBJECTID;
										let navnet = kommentarer_sorted[x].attributes.navn;
										let en_comment = kommentarer_sorted[x].attributes.kommentar;
										let bilde = kommentarer_sorted[x].attributes.bildeurl;
										let tiddato = new Date(kommentarer_sorted[x].attributes.timedate);

										let day = tiddato.getDate();
										let month = tiddato.getMonth() + 1;
										let year = tiddato.getFullYear();
										let hours = tiddato.getHours();
										let minutes = tiddato.getMinutes();

										var ant_likes = 0;
										var liked = false;
										for (var z in likes) {
											//sjekker om "likens" foreign key er lik som kommentarens primary key. Hvis ja, increment antall likes variable
											if (likes[z].attributes.kommentar_id == comment_id) {
												ant_likes+=1;
											};
										};


										if (day <10) {
											day="0"+day
										};
										if (month <10) {
											month="0"+month
										};
										if (hours <10) {
											hours="0"+hours
										};
										if (minutes <10) {
											minutes="0"+minutes
										};
										let tidspunkt = ""+day+"."+month+"."+year+"&nbsp;"+hours+":"+minutes;
										$("#kommentarfelt").append(
											'<div class="singlecomment" id="'+comment_id+'"> <div class="bilde"><img src="' + bilde + '"/></div><div class="tekst"><div class="navn"><b>' + navnet + '</b></div><div class="komm">' + en_comment + '</div> <div class="dato">'+tidspunkt+'</div></div><div class="likediv"><img class="likebilde" class="'+comment_id+'" src="https://kartsarp.github.io/kartsarp.github.io/likes_univ_2.svg" /><div class="likecount"</div></div></div>');

										if (ant_likes>=1) {
											//$("#" + comment_id).find(".likebilde").attr("src", "https://kartsarp.github.io/kartsarp.github.io/nolikes.svg");
											$("#" + comment_id).find(".likebilde").css("background-color", "pink");
											$("#" + comment_id).find(".likecount").text(ant_likes);
										};

										
										
									};

								});


						});
				};
				hentkommentarer();

				function addComment(nydata) {
					console.log(nydata);
					var komment_id = num_com+1; 
					let tiddato = new Date();
					let day = tiddato.getDate();
					let month = tiddato.getMonth() + 1;
					let year = tiddato.getFullYear();
					let hours = tiddato.getHours();
					let minutes = tiddato.getMinutes();

			      if (day <10) {
			      	day="0"+day
			      };
			      if (month <10) {
			      	month="0"+month
			      };
			      if (hours <10) {
			      	hours="0"+hours
			      };
			      if (minutes <10) {
			      	minutes="0"+minutes
			      };
			      let tidspunkt = ""+day+"."+month+"."+year+"&nbsp;"+hours+":"+minutes;
					$("#kommentarfelt").prepend(
						'<div class="singlecomment gradient-border" id="'+komment_id+'"> <div class="bilde"><img src="' + nydata.attributes.bildeurl + '"/></div><div class="tekst"><div class="navn"><b>' + nydata.attributes.navn + '</b></div><div class="komm">' + nydata.attributes.kommentar + '</div> <div class="dato">'+tidspunkt+'</div></div></div>');
					setTimeout(function() {
						$("#"+komment_id).removeClass("gradient-border");
					},2500);
					
					num_com+=1;
				};




				//Koden inne i Innlogget funksjonen kjøres bare for personer som har logget inn med facebook.
				function innlogget() {
					console.log('Welcome!  Fetching your information.... ');
					FB.api('/me', function(response) {
						console.log('Successful login for: ' + response.name);
						console.log(response);
						document.getElementById('status').innerHTML = 'Du er nå logget inn ' + response.name + '!';
						//Vis skjemaet som skal brukes til å sende inn kommentaren
						$(".facelogin").hide();
						$("#skjema").show();
						$("#sendkommentar").css("display", "flex");

						brukerid = response.id;

						if (jQuery.isEmptyObject(likes)) {
							p = new Proxy({}, handler);
							console.log("EMPTY");
						} else {
							console.log("NOT empty");
							sjekkLikes(brukerid);
						};

						
						navn = response.name;
						console.log(brukerid);
						console.log(likes);
						//sjekkLikes(brukerid);

						function applyEdits(parametere) {
							featureLayer.applyEdits(parametere).then(function(editsResult) {
									// Get the objectId of the newly added feature.
									// Call selectFeature function to highlight the new feature.
									console.log(editsResult.addFeatureResults);
									if (editsResult.addFeatureResults.length > 0) {
										const objectId = editsResult.addFeatureResults[0].objectId;

									}
								}).then(function() {
									//Tøm kommentar-textfeltet
									$("#komment").val("");
									//$("#kommentarfelt").empty();
									//hentkommentarer();
								})
								//Throw errorer som måtte dukke opp i consollen
								.catch(function(error) {
									console.log("===============================================");
									console.error("[ applyEdits ] FAILURE: ", error.code, error.name,
										error.message);
									console.log("error = ", error);
								});
						};

						function giveLike(parametere) {
							likeTable.applyEdits(parametere).then(function(editsResult) {
									// Get the objectId of the newly added feature.
									// Call selectFeature function to highlight the new feature.
									console.log(editsResult.addFeatureResults);
									if (editsResult.addFeatureResults.length > 0) {
										const objectId = editsResult.addFeatureResults[0].objectId;

									}
								}).then(function() {
									//Etter fullført innsending av Like
									console.log("fullført like-send");

									//Fjerne onclick eventet som lar deg gi en like dersom du nettopp har sendt inn en like på den kommentaren. 
									$(".likediv").find("."+ parametere.addFeatures[0].attributes.kommentar_id).off();
									console.log($("#"+parametere.addFeatures[0].attributes.kommentar_id).find("."+parametere.addFeatures[0].attributes.kommentar_id).text());									


								})
								//Throw errorer som måtte dukke opp i consollen
								.catch(function(error) {
									console.log("===============================================");
									console.error("[ applyEdits ] FAILURE: ", error.code, error.name,
										error.message);
									console.log("error = ", error);
								});
						};



						//Endre BildeURL-atributten i punkt-objektet.
						function getMyPic(callback) {
							FB.api('/' + brukerid + '/picture', 'GET', {
									"redirect": "false"
								},
								function(response) {
									callback(response.data.url);
								}
							);
						};


						editFeature = new Graphic({
							geometry: {
								type: "point", // autocasts as new Point()
								longitude: 0.0,
								latitude: 0.0
							},
							attributes: {
								"userid": brukerid,
								"kommentar": "none",
								"navn": navn,
								"epost": "none",
								"bildeurl": "",
								"timedate": ""
							}
						});

						likedata = new Graphic({
							geometry: {
								type: "point", // autocasts as new Point()
								longitude: 0.0,
								latitude: 0.0
							},
							attributes: {
								"userid": brukerid,
								"numLikes": 1,
								"kommentar_id": 0
							}
						});


						function getPic() {
							getMyPic(function(url) {
								console.log("BildeUrl", url)
									//picurl = url;
								editFeature.attributes.bildeurl = url;
							});
						};
						//Kall funksjonen som skal endre på URLatributten. 
						getPic();

						// Setup the applyEdits parameter with adds.
						const edits = {
							addFeatures: [editFeature]
						};
						// Setter opp dataene som skal sendes inn til feature servicen med Key addFeatures
						const like = {
							addFeatures: [likedata]
						};

						$(".likebilde").on('click', function(like) {
							likedata.attributes.kommentar_id = $(this).attr("id");
							console.log($(this).attr("id"));
							giveLike({
								addFeatures: [likedata]
							});
						    
						})
						

						$("#sendkommentar").on('click', function(edits) {
							editFeature.attributes.kommentar = $("#komment").val();
							editFeature.attributes.timedate = new Date();
							console.log(editFeature);
							
							applyEdits({
								addFeatures: [editFeature]
							});
							addComment(editFeature);
						});				
					});
				};



			});

		});







  </script>

  <div class="cont">
	 <div id="tittel" class="flex-container">
		<div id="navn" class="flex-item">Grålum Allé</div>

		<div class="lenker flex-item">
		  <a class="planknapp" href='http://tema.webatlas.no/sarpsborg/planinnsyn?planid=22076' target="_blank">
			 <button  class="w3-button w3-white w3-border-white w3-round-large" >Plandokumenter</button>
		  </a>
		</div>

	 </div>
	 <div id="viewDiv"></div>
  </div>
  

  </div>
  <div id="comment">
	 <div id="fblogin">
		<fb:login-button size="xlarge"
		  scope="public_profile,email"
		  onlogin="checkLoginState();"
		  class="facelogin">
		  Logg inn
		</fb:login-button>
	 </div>
	 <div id="status">
	 </div>

	 <form id="skjema">
		<label for="komment">Din kommentar</label>
		<textarea rows="3" type="text" id="komment" name="komment" value="" placeholder="Skriv en kommentar..."></textarea>
	 </form>
	 

	 <button id="sendkommentar" class="w3-btn w3-blue w3-border w3-border-blue w3-round-large">Send kommentar</button>

	 <div id="kommentarfelt"></div>

	 <div id="velkomstBoks" class="velkommen" style="background-color: rgba(0, 0, 0, 0.5); display: none;">

		<!-- Modal content -->
		<div class="velkommen-innh">
		  <b>Takk for din tilbakemelding</b>
		  
		</div>

	 </div>

  </div>

</body>
</html>
